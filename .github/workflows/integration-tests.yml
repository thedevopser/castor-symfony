name: Integration Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  symfony-compatibility:
    name: Symfony ${{ matrix.symfony }} (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - symfony: "5.4.*"
            php: "8.0"
          - symfony: "6.4.*"
            php: "8.1"
          - symfony: "7.0.*"
            php: "8.2"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, ctype, iconv, intl

      - name: Create Symfony project
        run: |
          composer create-project symfony/skeleton:"${{ matrix.symfony }}" symfony-app
          cd symfony-app
          composer config minimum-stability dev
          composer config prefer-stable true

      - name: Install Bundle
        run: |
          cd symfony-app
          # Supprimer le paquet s'il existe dans le cache Composer
          composer remove thedevopser/castor-symfony --no-update || true
          # Configurer uniquement le dépôt local
          composer config repositories.packagist false
          composer config repositories.castor-symfony '{"type": "path", "url": "../", "options": {"symlink": true}}'
          # Installer le bundle
          composer require "thedevopser/castor-symfony:*@dev" --no-cache

      - name: Verify Installation
        run: |
          cd symfony-app
          php bin/console debug:container TheDevOpser\\CastorBundle\\CastorBundle
          php bin/console castor:install --no-interaction
          test -f castor.php || exit 1
          test -f castorPersonal.php || exit 1
          test -f config/packages/castor.yaml || exit 1
